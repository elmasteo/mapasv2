<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mapa interactivo ‚Äì Fichas multimedia</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<style>
:root{
  --bg:#0b0f14; --panel:#121822; --muted:#95a3b3; --text:#e8edf2; --accent:#52b788; --accent-2:#00c2ff;
  --card:#0f141b; --shadow:0 10px 30px rgba(0,0,0,.3);
}
*{box-sizing:border-box}
html,body,#app{height:100%;margin:0}
body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(120deg,#0b0f14,#111826);color:var(--text)}
#app{display:grid;grid-template-rows:auto 1fr}
.topbar{display:flex;gap:.75rem;align-items:center;padding:.75rem 1rem;border-bottom:1px solid rgba(255,255,255,.06);backdrop-filter:blur(6px);position:sticky;top:0;z-index:1000}
.brand{display:flex;align-items:center;gap:.5rem;font-weight:700;letter-spacing:.3px}
.brand .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(45deg,var(--accent),var(--accent-2));box-shadow:0 0 14px var(--accent-2)}
.topbar .actions{display:flex;gap:.5rem;margin-left:auto}
.btn{display:inline-flex;align-items:center;gap:.5rem;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.04);color:var(--text);padding:.55rem .8rem;border-radius:12px;cursor:pointer;transition:.2s;backdrop-filter:blur(2px)}
.btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.2)}
.btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#001018;border:none}
.field{position:relative;min-width:260px}
.field input{width:100%;background:#0c121a;border:1px solid rgba(255,255,255,.08);color:var(--text);padding:.6rem .8rem .6rem 2.2rem;border-radius:12px;outline:none}
.field svg{position:absolute;left:.6rem;top:50%;transform:translateY(-50%);opacity:.7}
#map{height:100%;width:100%}
.overlay{position:absolute;right:1rem;top:5.5rem;display:flex;flex-direction:column;gap:.6rem;z-index:999}
.chip{padding:.45rem .7rem;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);font-size:.85rem}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:1rem;z-index:2000}
.modal.open{display:flex}
.card{width:min(900px,96vw);background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:20px;box-shadow:var(--shadow);overflow:hidden}
.card header{display:flex;justify-content:space-between;align-items:center;padding:1rem 1rem .5rem 1rem;border-bottom:1px solid rgba(255,255,255,.06)}
.card h3{margin:.2rem 0;font-size:1.25rem}
.tags{display:flex;flex-wrap:wrap;gap:.4rem}
.tag{font-size:.75rem;background:rgba(82,183,136,.15);border:1px solid rgba(82,183,136,.4);color:#bff3d6;padding:.25rem .5rem;border-radius:999px}
.content{display:grid;gap:1rem;padding:1rem}
@media(min-width:900px){.content{grid-template-columns:1.4fr 1fr}}
.gallery{position:relative;border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.08)}
.gallery img, .gallery iframe, .gallery video{width:100%;height:360px;display:block;object-fit:cover;background:#0a0f14}
.thumbs{display:flex;gap:.4rem;overflow:auto;padding:.5rem;background:#0c1219;border-top:1px solid rgba(255,255,255,.06)}
.thumbs img{height:58px;width:96px;object-fit:cover;border-radius:10px;opacity:.75;cursor:pointer;border:1px solid rgba(255,255,255,.08)}
.thumbs img.active{opacity:1;outline:2px solid var(--accent)}
.details{display:flex;flex-direction:column;gap:.75rem}
.details p{color:var(--muted);line-height:1.6;margin:0}
audio{width:100%}
.close{cursor:pointer;border:none;background:transparent;color:var(--muted);font-size:1.2rem}
.leaflet-container{background:#0a0f14}
.leaflet-control-attribution{background:rgba(0,0,0,.4);color:#ddd;border-radius:10px;padding:.2rem .4rem}
.leaflet-popup-content-wrapper{background:#0d1320;color:#e8edf2;border:1px solid rgba(255,255,255,.1);border-radius:14px}
.leaflet-popup-tip{background:#0d1320}
</style>
</head>
<body>
<div id="app">
  <div class="topbar">
    <div class="brand"><span class="dot"></span>Mapa interactivo</div>
    <div class="field" style="flex:1;max-width:520px">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="1.7"/></svg>
      <input id="search" placeholder="Buscar por t√≠tulo, descripci√≥n o etiquetas‚Ä¶" />
    </div>
    <div class="actions">
      <button id="locate" class="btn" title="Mi ubicaci√≥n">üìç Ubicarme</button>
      <button id="reset" class="btn" title="Ver todo">üîé Reset</button>
      <button id="theme" class="btn primary" title="Cambiar tema">Modo din√°mico</button>
    </div>
  </div>
  <div style="position:relative">
    <div id="map"></div>
    <div class="overlay">
      <div class="chip">Clic en un punto para abrir/crear ficha</div>
      <div class="chip" id="count">0 elementos</div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="card">
    <header>
      <div>
        <h3 id="m-title">T√≠tulo</h3>
        <div class="tags" id="m-tags"></div>
      </div>
      <button class="close" id="m-close">‚úï</button>
    </header>
    <div class="content">
      <div>
        <div class="gallery" id="m-gallery"></div>
        <div class="thumbs" id="m-thumbs"></div>
      </div>
            <!-- MODAL -->
      <div class="details">
        <textarea id="m-desc" placeholder="Descripci√≥n..." style="width:100%;height:80px;background:#0c121a;color:var(--text);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:.5rem;"></textarea>
        <input type="text" id="m-tags-input" placeholder="Etiquetas separadas por coma" style="width:100%;margin:.5rem 0;padding:.5rem;border-radius:12px;background:#0c121a;border:1px solid rgba(255,255,255,.08);color:var(--text)">

        <label for="m-images">üì∑ Im√°genes:</label>
        <input type="file" id="m-images" multiple accept="image/*" style="margin-bottom:.5rem">

        <label for="m-audio">üéµ Audios:</label>
        <input type="file" id="m-audio" multiple accept="audio/*" style="margin-bottom:.5rem">

        <label for="m-video">üé• Videos:</label>
        <input type="file" id="m-video" multiple accept="video/*" style="margin-bottom:.5rem">

        <button id="m-save" class="btn primary" style="width:100%">Guardar lugar</button>
      </div>

    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
// --- Cargar lugares desde JSON ---
async function loadPlaces() {
  try {
    const res = await fetch('/lugares.json'); // O la ruta correcta
    if (!res.ok) throw new Error('No se pudo cargar lugares.json');
    const data = await res.json();
    data.forEach(p => {
      places.push(p);
      addPlace(p);
    });
    if (places.length) map.fitBounds(cluster.getBounds(), { padding:[20,20] });
    updateCount();
  } catch(e) {
    console.error('Error cargando lugares:', e);
  }
}

loadPlaces();

// --- CONFIGURA TU CLOUDINARY ---
const CLOUDINARY_CLOUD_NAME = 'drssjjayn';
const CLOUDINARY_UPLOAD_PRESET = 'netlify_upload';

// --- MAPA ---
const map = L.map('map', { zoomControl:false, worldCopyJump:true }).setView([4.7110, -74.0721], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19, attribution:'&copy; OpenStreetMap' }).addTo(map);
L.control.zoom({ position:'bottomright' }).addTo(map);

const cluster = L.markerClusterGroup({ showCoverageOnHover:false, spiderfyOnMaxZoom:true, maxClusterRadius:48 });
const icon = L.divIcon({ html:`<div style="width:22px;height:22px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:0 0 0 4px rgba(0,194,255,.15), 0 0 20px rgba(0,194,255,.4);"></div>`, className:'marker-dot', iconSize:[22,22]});
const markersIndex = new Map();
const places = [];

function updateCount(){ document.getElementById('count').textContent = `${cluster.getLayers().length} elemento${cluster.getLayers().length!==1?'s':''}`;}
function addPlace(p){
  const m = L.marker(p.coords, { icon });
  m.bindPopup(`<strong>${p.title}</strong><br><small>${(p.tags||[]).join(' ¬∑ ')}</small>`);
  m.on('click', ()=> openModal(p));
  cluster.addLayer(m);
  markersIndex.set(p.id, m);
}
map.addLayer(cluster);

// --- Modal ---
const modal = document.getElementById('modal');
const mTitle = document.getElementById('m-title');
const mTags = document.getElementById('m-tags');
const mDesc = document.getElementById('m-desc');
const mTagsInput = document.getElementById('m-tags-input');
const mGallery = document.getElementById('m-gallery');
const mThumbs = document.getElementById('m-thumbs');
const mImages = document.getElementById('m-images');
const mAudio = document.getElementById('m-audio');
const mVideo = document.getElementById('m-video');
const mSave = document.getElementById('m-save');
let currentPlace = null;
let lastClick = null;

document.getElementById('m-close').addEventListener('click', ()=> modal.classList.remove('open'));
modal.addEventListener('click', e=>{ if(e.target===modal) modal.classList.remove('open'); });

function openModal(p){
  currentPlace = p || { id:Date.now(), coords:lastClick || map.getCenter(), title:'Nuevo lugar', media:{} };
  
  // Mostrar t√≠tulo como texto, editable solo al presionar "Editar"
  mTitle.textContent = currentPlace.title || '';
  
  mTags.innerHTML = (currentPlace.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('');
  mDesc.value = currentPlace.description || '';
  mTagsInput.value = (currentPlace.tags||[]).join(',');
  
  mGallery.innerHTML = ''; mThumbs.innerHTML = '';
  const items = [];
  (currentPlace.media?.images || []).forEach(src => items.push({type:'img', src}));
  (currentPlace.media?.videos || []).forEach(src => items.push({type:'video', src}));
  (currentPlace.media?.audios || []).forEach(src => items.push({type:'audio', src}));

  function renderMain(it){
    if(it.type==='video'){ mGallery.innerHTML = `<video src="${it.src}" controls style="width:100%;height:360px"></video>`; }
    else if(it.type==='img'){ mGallery.innerHTML = `<img src="${it.src}" alt="${currentPlace.title}">`; }
    else if(it.type==='audio'){ mGallery.innerHTML = `<audio src="${it.src}" controls></audio>`; }
    else { mGallery.innerHTML = ''; }
  }
  items.forEach((it,idx)=>{
  const t = document.createElement('img');
  if(it.type==='img'){ 
    t.src = it.src; 
    t.title='Imagen'; 
  }
  else if(it.type==='video'){ 
    // mini video como thumb
    const v = document.createElement('video');
    v.src = it.src;
    v.muted = true;
    v.playsInline = true;
    v.style.width = "96px";
    v.style.height = "58px";
    v.style.objectFit = "cover";
    v.title = "Video";
    v.addEventListener('click', ()=>{
      [...mThumbs.children].forEach(n=>n.classList.remove('active'));
      v.classList.add('active'); renderMain(it);
    });
    mThumbs.appendChild(v);
    if(idx===0) v.classList.add('active');
    return;
  }
  else if(it.type==='audio'){ 
    // √çcono de audio base64 inline
    t.src = "data:image/svg+xml;base64,"+btoa(`<svg xmlns='http://www.w3.org/2000/svg' width='96' height='58'><rect width='100%' height='100%' fill='#222'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='white' font-size='20'>üéµ</text></svg>`);
    t.title='Audio'; 
  }

  t.addEventListener('click', ()=>{
    [...mThumbs.children].forEach(n=>n.classList.remove('active'));
    t.classList.add('active'); renderMain(it);
  });
  mThumbs.appendChild(t);
  if(idx===0) t.classList.add('active');
});

  renderMain(items[0]||{type:'none'});
  
  // Crear botones "Editar" y "Eliminar" si no existen
  if(!document.getElementById('m-edit')){
    const btnEdit = document.createElement('button');
    btnEdit.id='m-edit'; btnEdit.className='btn'; btnEdit.textContent='Editar'; 
    btnEdit.addEventListener('click', ()=> enableEditing(true));
    modal.querySelector('.details').appendChild(btnEdit);

    const btnDel = document.createElement('button');
    btnDel.id='m-delete'; btnDel.className='btn'; btnDel.textContent='Eliminar';
    btnDel.addEventListener('click', async ()=>{
      if(!confirm('¬øEliminar este lugar?')) return;
      // Eliminar del mapa
      const marker = markersIndex.get(currentPlace.id);
      if(marker){ cluster.removeLayer(marker); markersIndex.delete(currentPlace.id); }
      // Eliminar de places
      const idx = places.findIndex(x=>x.id===currentPlace.id);
      if(idx>=0) places.splice(idx,1);
      updateCount();
      // Guardar cambios en CMS/GitHub
      await fetch('/.netlify/functions/cms-save',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({deleteId: currentPlace.id})
      });
      modal.classList.remove('open');
    });
    modal.querySelector('.details').appendChild(btnDel);
  }

  enableEditing(false);
  modal.classList.add('open');

  function enableEditing(flag){
    mDesc.disabled = !flag;
    mTagsInput.disabled = !flag;
    mImages.disabled = !flag;
    mAudio.disabled = !flag;
    mVideo.disabled = !flag;
    mTitle.contentEditable = flag; // Editable t√≠tulo
    mSave.style.display = flag ? 'block' : 'none';
  }
}

map.on('click', e=>{ lastClick = e.latlng; openModal(null); });

// --- Subida directa a Cloudinary ---
async function uploadFileDirect(file, type){
  if(!file) return null;

  // Detectar resource_type correcto
  let resourceType = "auto";
  if(type === "image") resourceType = "image";
  else if(type === "video") resourceType = "video";
  else if(type === "audio") resourceType = "video"; // Cloudinary maneja audio como "video"
  else resourceType = "raw";

  const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/${resourceType}/upload`;

  const form = new FormData();
  form.append("file", file);
  form.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

  const res = await fetch(url, { method: "POST", body: form });
  const json = await res.json();

  if(!json.secure_url) throw new Error("Cloudinary upload failed");
  return json.secure_url;
}

// --- Guardar lugar ---
mSave.addEventListener("click", async () => {
  const title = mTitle.textContent.trim() || "Inserta nombre";
  const desc = mDesc.value;
  const tags = mTagsInput.value.split(",").map(t=>t.trim()).filter(Boolean);

  // Subida de medios
  const media = { images:[], audios:[], videos:[] };
  for(const f of mImages.files) media.images.push(await uploadFileDirect(f, "image"));
  for(const f of mAudio.files) media.audios.push(await uploadFileDirect(f, "audio"));
  for(const f of mVideo.files) media.videos.push(await uploadFileDirect(f, "video"));

  // Actualizar datos del lugar
  currentPlace.title = title;
  currentPlace.description = desc;
  currentPlace.tags = tags;
  currentPlace.media = media;
  currentPlace.coords = [lastClick.lat, lastClick.lng];

  if(!places.find(p => p.id === currentPlace.id)) {
    places.push(currentPlace);
    addPlace(currentPlace);
  }

  updateCount();

  // Persistir en Netlify CMS (cms-save actualiza lugares.json en el repo)
  await fetch("/.netlify/functions/cms-save", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(currentPlace)
  });

  modal.classList.remove("open");
});

// --- B√∫squeda ---
document.getElementById('search').addEventListener('input', e=>{
  const q = e.target.value.trim().toLowerCase();
  cluster.clearLayers(); markersIndex.clear();
  const filtered = places.filter(p=>{
    const blob = [p.title,p.description,...(p.tags||[])].join(' ').toLowerCase();
    return blob.includes(q);
  });
  filtered.forEach(addPlace);
  if(filtered.length) map.fitBounds(cluster.getBounds(),{padding:[30,30]});
  updateCount();
});

// --- Reset ---
document.getElementById('reset').addEventListener('click', ()=>{
  document.getElementById('search').value='';
  cluster.clearLayers(); markersIndex.clear(); places.forEach(addPlace);
  map.fitBounds(cluster.getBounds(), { padding:[20,20] });
  updateCount();
});

// --- Tema din√°mico ---
const themeBtn = document.getElementById('theme');
let dynamic=false,raf,startTs;
themeBtn.addEventListener('click', ()=>{
  dynamic=!dynamic; themeBtn.textContent = dynamic?'Din√°mico: ON':'Modo din√°mico';
  if(dynamic){ animateBg(); } else { cancelAnimationFrame(raf); document.body.style.background='linear-gradient(120deg,#0b0f14,#111826)'; }
});
function animateBg(ts){ if(!startTs) startTs=ts||0; const t=((ts||0)-startTs)/1000; const c1=`hsl(${(200+40*Math.sin(t))%360} 45% 8%)`; const c2=`hsl(${(220+40*Math.cos(t*0.8))%360} 45% 13%)`; document.body.style.background=`linear-gradient(120deg, ${c1}, ${c2})`; raf=requestAnimationFrame(animateBg);}
</script>
</body>
</html>
